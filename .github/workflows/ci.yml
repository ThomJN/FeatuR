name: CI
on:
  push:
    branches:
      - master
jobs:
  build:
    name: Build & Run tests
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:5.7
        env:
            MYSQL_ROOT_PASSWORD: "test123456"
        ports:
            - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    steps:
      - uses: actions/checkout@v2
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: '3.1.x'
      - name: Build with dotnet
        run: dotnet build --configuration Release
      - name: Test with dotnet
        env:
          ConnectionStringMySQL: "Server=localhost; Port=${{ job.services.mysql.ports[3306] }}; User=root; Password=test123456; Database=featur;"
        run: dotnet test ./FeatuR.sln --no-build -c Release -p:CollectCoverage=true -p:CoverletOutputFormat=opencover
      - name: Upload test results to Codacy
        uses: codacy/codacy-coverage-reporter-action@master
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: test/**/coverage.opencover.xml
  deploy:
    name: Deploy to MyGet
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Pack NuGet package
        run: dotnet pack --configuration Release --version-suffix "ci"
      - name: Push package to MyGet
        run: dotnet nuget push **/*.nupkg
              --api-key ${{ secrets.MYGET_DEPLOY_KEY }}
              --source https://www.myget.org/F/featur/api/v3/index.json
              --no-symbols
              --skip-duplicate
